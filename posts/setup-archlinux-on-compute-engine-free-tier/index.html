<!doctype html><html lang=ja><head><title>GCP Compute Engineの永久無料枠でarchlinuxを起動する :: blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="前置き tailscale + 自宅サーバ群でそれなりに快適なサーバ生活を送っていた私ですが、「やはりクラウドにも1台くらい持っておくべきだよな、社会人として」、という思いつきにより、適当にサーバを立てることにしました。 条件は以下です。単純ですね。 archlinuxが動くこと なるべく安いこと スペックはneovimが快適に動けばヨシ AWSでないこと(AWSが嫌いというわけではなく、普段使っていないものにしたい) リージョン"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/setup-archlinux-on-compute-engine-free-tier/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/blue.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/blue.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="_kei_s"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="og:title" content="GCP Compute Engineの永久無料枠でarchlinuxを起動する"><meta property="og:description" content="前置き tailscale + 自宅サーバ群でそれなりに快適なサーバ生活を送っていた私ですが、「やはりクラウドにも1台くらい持っておくべきだよな、社会人として」、という思いつきにより、適当にサーバを立てることにしました。 条件は以下です。単純ですね。 archlinuxが動くこと なるべく安いこと スペックはneovimが快適に動けばヨシ AWSでないこと(AWSが嫌いというわけではなく、普段使っていないものにしたい) リージョン"><meta property="og:url" content="/posts/setup-archlinux-on-compute-engine-free-tier/"><meta property="og:site_name" content="blog"><meta property="og:image" content="/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="技術"><meta property="article:published_time" content="2022-08-11 16:00:00 +0900 +0900"><script data-goatcounter=https://k16em.goatcounter.com/count async src=//gc.zgo.at/count.js></script></head><body class=blue><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>blog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/categories>カテゴリ</a></li><li><a href=/tags>タグ</a></li><li><a href=/archives>月別アーカイブ</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/categories>カテゴリ</a></li><li><a href=/tags>タグ</a></li><li><a href=/archives>月別アーカイブ</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/posts/setup-archlinux-on-compute-engine-free-tier/>GCP Compute Engineの永久無料枠でarchlinuxを起動する</a></h1><div class=post-meta><span class=post-date>2022-08-11</span>
<span class=post-author>:: kei</span></div><span class=post-tags>#<a href=/tags/archlinux/>archlinux</a>&nbsp;
#<a href=/tags/gcp/>gcp</a>&nbsp;</span><div class=post-content><div><h2 id=前置き>前置き<a href=#前置き class=hanchor arialabel=Anchor>&#8983;</a></h2><p>tailscale + 自宅サーバ群でそれなりに快適なサーバ生活を送っていた私ですが、「やはりクラウドにも1台くらい持っておくべきだよな、社会人として」、という思いつきにより、適当にサーバを立てることにしました。</p><p>条件は以下です。単純ですね。</p><ul><li>archlinuxが動くこと</li><li>なるべく安いこと</li><li>スペックはneovimが快適に動けばヨシ</li><li>AWSでないこと(AWSが嫌いというわけではなく、普段使っていないものにしたい)</li><li>リージョンはUS, JP, TWくらいならどこでもいい(EUは遠すぎる)</li></ul><p>ハードルとしてはほとんど地面すれすれぐらいの低さです。<br>この条件で海外VPSサービスなども考慮に入れると選択肢は無限大なのですが、ここは<del>たまたまTwitterでみかけた記事をそのまま参考にします</del>メディアの力を頼ることにします。<br><a href=https://www.publickey1.jp/blog/22/free_tier2022.html>期限の制約なく無料で使えるクラウド「Free Tier」主要サービスまとめ。2022年版</a></p><p>lifetime-freeで仮想マシンを与えてくれるサービスが2つもいたので、<strong>なるべく安い</strong> を飛び越して無料にすることができそうです。<br>軽く調べたところ、GCPのCompute Engineには、archlinuxのイメージを使えるらしいので、記事タイトルでお察しではありますが、即決でこちらにしました。<br>(ちなみに、スペックはOCIもGCPも無料にしてはいい感じでした。OCIはいろいろもうちょっと頑張って覇権取りに行く姿勢を見せてほしい……)</p><h2 id=やっていき>やっていき<a href=#やっていき class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=前準備>前準備<a href=#前準備 class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=gcpのアカウントを作る>GCPのアカウントを作る<a href=#gcpのアカウントを作る class=hanchor arialabel=Anchor>&#8983;</a></h4><p><a href="https://cloud.google.com/gcp/?hl=ja">こちら</a>からどうぞ。
初回だと4万円ぶんくらいのクレジットも貰えるので、設定ミスって請求がばくはつしてもある程度はあんしんです。<br>アカウントの作成と同時に、ワークスペースが作成されます。概念的にはAWSのアカウントに相当するっぽい。この中に、VPCやCE, GKEなどのリソースが作成されていくようです。</p><h4 id=ローカルにsdkを導入する>ローカルにSDKを導入する<a href=#ローカルにsdkを導入する class=hanchor arialabel=Anchor>&#8983;</a></h4><p>作業環境はarchlinuxです。
それ以外の環境を使っている人がもしいれば、<a href=https://cloud.google.com/sdk/>公式のドキュメント</a>を参考に導入してください。</p><p>archlinuxの場合、AURから<a href=https://aur.archlinux.org/packages/google-cloud-sdk>google-cloud-sdk</a>をインストールすることができます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% yay -S google-cloud-sdk
</span></span></code></pre></div><p>このあと <code>gcloud</code> コマンドを叩いてみると、ほかに依存パッケージがいたようで、エラーを吐かれたのでそれもインストールします。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% sudo pacman -S libxcrypt-compat
</span></span></code></pre></div><h4 id=gcloudコマンドにgcpの認証を通す>gcloudコマンドにGCPの認証を通す<a href=#gcloudコマンドにgcpの認証を通す class=hanchor arialabel=Anchor>&#8983;</a></h4><p><code>aws configure</code> みたいなやつです。<br>ブラウザを勝手に立ち上げて、いつものGoogle認証を許可すればOKで、事前にIAMユーザ作っておいてACCESS_KEY, SECRET_KEYをコピペして……みたいなことは不要でした。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% gcloud init
</span></span><span style=display:flex><span><span style=color:#75715e># いろいろ出るが省略</span>
</span></span><span style=display:flex><span><span style=color:#75715e># GCPの認証を通す</span>
</span></span><span style=display:flex><span>You must log in to <span style=color:#66d9ef>continue</span>. Would you like to log in <span style=color:#f92672>(</span>Y/n<span style=color:#f92672>)</span>? <span style=color:#75715e># Enterを叩くとブラウザが開くので、Googleアカウントの認証を通す</span>
</span></span><span style=display:flex><span>You are logged in as: <span style=color:#f92672>[</span>your.mail.address@example.com<span style=color:#f92672>]</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># プロジェクトを選ぶ</span>
</span></span><span style=display:flex><span>Pick cloud project to use:
</span></span><span style=display:flex><span> <span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> hoge-project <span style=color:#75715e># デフォルトで作られているプロジェクト名</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> Enter a project ID
</span></span><span style=display:flex><span> <span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> Create a new project
</span></span><span style=display:flex><span>Please enter numeric choice or text value <span style=color:#f92672>(</span>must exactly match list item<span style=color:#f92672>)</span>:  <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Your current project has been set to: <span style=color:#f92672>[</span>hoge-project<span style=color:#f92672>]</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># デフォルトリージョンを選択する</span>
</span></span><span style=display:flex><span>Do you want to configure a default Compute Region and Zone? <span style=color:#f92672>(</span>Y/n<span style=color:#f92672>)</span>?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Which Google Compute Engine zone would you like to use as project default?
</span></span><span style=display:flex><span>If you <span style=color:#66d9ef>do</span> not specify a zone via a command line flag <span style=color:#66d9ef>while</span> working with Compute Engine resources, the default is assumed.
</span></span><span style=display:flex><span><span style=color:#75715e># リストが出るが長いので省略</span>
</span></span><span style=display:flex><span>Too many options <span style=color:#f92672>[</span>104<span style=color:#f92672>]</span>. Enter <span style=color:#e6db74>&#34;list&#34;</span> at prompt to print choices fully.
</span></span><span style=display:flex><span>Please enter numeric choice or text value <span style=color:#f92672>(</span>must exactly match list item<span style=color:#f92672>)</span>:  <span style=color:#ae81ff>11</span> <span style=color:#75715e># 無料枠を使いたいのでオレゴンを選択</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Your project default Compute Engine zone has been set to <span style=color:#f92672>[</span>us-west1-b<span style=color:#f92672>]</span>.
</span></span><span style=display:flex><span>You can change it by running <span style=color:#f92672>[</span>gcloud config set compute/zone NAME<span style=color:#f92672>]</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Your project default Compute Engine region has been set to <span style=color:#f92672>[</span>us-west1<span style=color:#f92672>]</span>.
</span></span><span style=display:flex><span>You can change it by running <span style=color:#f92672>[</span>gcloud config set compute/region NAME<span style=color:#f92672>]</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># このあともいろいろ出るが、ここに設定あるからね系のアナウンスなので省略</span>
</span></span></code></pre></div><h3 id=archlinuxのインスタンスを起動する>archlinuxのインスタンスを起動する<a href=#archlinuxのインスタンスを起動する class=hanchor arialabel=Anchor>&#8983;</a></h3><p>イメージはGCP側で用意されているようです。<br><a href=https://github.com/GoogleCloudPlatform/compute-archlinux-image-builder>GoogleCloudPlatform/compute-archlinux-image-builder</a>のREADMEに従って、インスタンスを作成・起動します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute instances create arch-1 <span style=color:#ae81ff>\ </span><span style=color:#75715e># インスタンス・ストレージ名になる</span>
</span></span><span style=display:flex><span>	--image-project<span style=color:#f92672>=</span>arch-linux-gce <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--image-family<span style=color:#f92672>=</span>arch <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--machine-type<span style=color:#f92672>=</span>e2-micro <span style=color:#ae81ff>\ </span><span style=color:#75715e># 永久無料枠のサイズにする</span>
</span></span><span style=display:flex><span>	--boot-disk-size<span style=color:#f92672>=</span>30GB <span style=color:#75715e># 30GBまでストレージ無料なので、せっかくだしデフォルトより大きくしておく</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># warnが出るけど、気にしない</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME    ZONE        MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP   STATUS
</span></span><span style=display:flex><span>arch-1  us-west1-b  e2-micro                   <span style=color:#f92672>{</span>INTERNAL_IP<span style=color:#f92672>}</span>   <span style=color:#f92672>{</span>EXTERNAL_IP<span style=color:#f92672>}</span>  RUNNING
</span></span></code></pre></div><p>これでインスタンスが作成・起動されます。
<img src=/images/setup-archlinux-on-compute-engine-free-tier/compute-engine.png alt=Webコンソールのスクリーンショット></p><p>ブラウザからSSHボタンを押すと、別窓でインスタンスに対するSSHが起動します。<br>また、<code>gcloud compute ssh ${インスタンス名}</code> で、<code>vagrant ssh</code> のような感覚で、ターミナルから接続することもできます。<br>接続時にはブラウザ経由の場合はGCPに登録してあるメールアドレスのユーザ名部分、<code>gcloud</code> 経由の場合には接続元のマシンのユーザ名で新規ユーザが作成されます。</p><h3 id=起動後>起動後<a href=#起動後 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>とりあえずパッケージの更新をしておきましょう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% sudo pacman -S archlinux-keyring
</span></span><span style=display:flex><span>% sudo pacman -Syyu
</span></span></code></pre></div><p>これでおわりです。<br>あとはお好きにどうぞ。</p><h3 id=そのほかやっておくこと>そのほかやっておくこと<a href=#そのほかやっておくこと class=hanchor arialabel=Anchor>&#8983;</a></h3><h4 id=pingに応答しないようにしておく>pingに応答しないようにしておく<a href=#pingに応答しないようにしておく class=hanchor arialabel=Anchor>&#8983;</a></h4><p>なぜかインターネットからのpingに応答するのがデフォルトになっているので、 <code>default-allow-icmp</code> を削除する。<br>設定は別画面にあるので、スクショのようにして探す。<br><img src=/images/setup-archlinux-on-compute-engine-free-tier/firewall.png alt=ファイアウォール設定画面までののスクリーンショット></p><h4 id=sshのポート番号を変えておく>sshのポート番号を変えておく<a href=#sshのポート番号を変えておく class=hanchor arialabel=Anchor>&#8983;</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% sudo pacman -S vim
</span></span><span style=display:flex><span>% export EDITOR<span style=color:#f92672>=</span>vim
</span></span><span style=display:flex><span>% sudoedit /etc/ssh/sshd_config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># `# Port 22` の行を探し、`Port {任意の番号}` に変えておく</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>% sudo systemctl restart sshd
</span></span></code></pre></div><p>上記が終わったら、GCPのファイアウォール設定から、 <code>default-allow-ssh</code> のルールを探し、ポート番号を変更する。</p><h4 id=普通にsshできるようにする>普通にsshできるようにする<a href=#普通にsshできるようにする class=hanchor arialabel=Anchor>&#8983;</a></h4><p><code>gcloud compute ssh</code> でもいいんだけど、ポート番号変えたりするとつらいところがあるので、普通にsshできるように設定をエクスポートする。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>% gcloud compute config-ssh
</span></span></code></pre></div><p>これを実行すると、<code>~/.ssh/config</code> に設定が追記されるので、適宜ユーザ名やポート番号を追記・編集する。</p><h4 id=予算アラートを設定する>予算アラートを設定する<a href=#予算アラートを設定する class=hanchor arialabel=Anchor>&#8983;</a></h4><p>Webコンソールからの導線がわかりにくいので、画面上部の検索メニューに <code>予算とアラート</code> と入力して設定ページに飛ぶ。<br>とりあえず1円で設定しておけばよさげ。クーポンや無料枠ぶんを反映する設定にしておかないと、割引前の請求額でアラートを飛ばすようなので、そこだけ注意。</p><h2 id=感想>感想<a href=#感想 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>わりとさっくりいけたので特に書くことがない……。<br>とりあえず立てたインスタンスにはこれからSELinuxをいれたりなんだりして、便利に使っていこうと思います。</p><p>あと今回ほとんど初めてGCPを触ったけど、AWSとはやっぱり文化が違う感じがしていて、AWS, Azure, OCIに連なるサービスというより、どちらかというと強いherokuみたいな印象を受けた。<br>コンソールが使いにくい・デフォルト設定がわりと不思議、みたいなところはあるけど、極端なつらみはない(Windows版firefoxで表示が崩れまくるので、別のところでつらみはあったけど)ので、個人利用程度だったら人に勧めるかも。</p><p>そんな感じです。</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=/posts/isu12q-report/><span class=button__text>ISUCON初参加のふりかえり</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>